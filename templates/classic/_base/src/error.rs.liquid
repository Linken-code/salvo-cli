use salvo::http::ParseError;
{% if db_type == "mongodb" %}
use mongodb::bson::document::ValueAccessError as MongoBsonAccessError;
use mongodb::bson::oid::Error as MongoBsonOidError;
use mongodb::error::Error as MongoDbErroror;
{% endif %}
use thiserror::Error;

#[derive(Error, Debug)]
pub enum AppError {
    #[error("public: `{0}`")]
    Public(String),
    #[error("internal: `{0}`")]
    Internal(String),
    #[error("salvo internal error: `{0}`")]
    Salvo(#[from] ::salvo::Error),
    #[error("error:`{0}`")]
    AnyHow(#[from] anyhow::Error),
    #[error("http::ParseError:`{0}`")]
    ParseError(#[from] ParseError),
    {% if db_lib == "sqlx" %}
    #[error("sqlx::Error:`{0}`")]
    SqlxError(#[from] sqlx::Error),
    {% endif %}
    {% if db_lib == "seaorm" %}
    #[error("seaorm::DbError:Error:`{0}`")]
    DbError(#[from] seaorm::DbError),
    {% endif %}
    {% if db_lib == "diesel" %}
    #[error("diesel::result::Error:`{0}`")]
    DieselErr(#[from] diesel::result::Error),
    {% endif %}
    {% if db_lib == "rbatis" %}
    #[error("rbatis::Error:`{0}`")]
    RbatisErr(#[from] rbatis::Error),
    {% endif %}
    {% if db_type == "mongodb" %}
    #[error("mongodb::error::Error:`{0}`")]
    MongoDbError(#[from] MongoDbErroror),
    #[error("mongodb::bson::document::ValueAccessError:`{0}`")]
    MongoBsonAccessError(#[from] MongoBsonAccessError),
    #[error("mongodb::bson::oid::Error`{0}`")]
    MongoBsonOidError(#[from] MongoBsonOidError),
    {% endif %}
    #[error("ValidationError:`{0}`")]
    ValidationError(#[from] validator::ValidationErrors),
}
impl AppError {
    pub fn public<S: Into<String>>(msg: S) -> Self {
        Self::Public(msg.into())
    }

    pub fn internal<S: Into<String>>(msg: S) -> Self {
        Self::Internal(msg.into())
    }
}

impl EndpointOutRegister for AppError {
    fn register(_components: &mut salvo::oapi::Components, operation: &mut salvo::oapi::Operation) {
        operation.responses.insert(
            StatusCode::INTERNAL_SERVER_ERROR.as_str(),
            oapi::Response::new("Internal server error").add_content("application/json", StatusError::to_schema(components)),
        );
        operation.responses.insert(
            StatusCode::NOT_FOUND.as_str(),
            oapi::Response::new("Not found").add_content("application/json", StatusError::to_schema(components)),
        );
        operation.responses.insert(
            StatusCode::BAD_REQUEST.as_str(),
            oapi::Response::new("Bad request").add_content("application/json", StatusError::to_schema(components)),
        );
    }
}